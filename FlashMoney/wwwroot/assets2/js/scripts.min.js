/*!
 * sequest-app
 * A Simple SRP (Service Request Platform) Application
 * 
 * @author Terry Pouke
 * @version 0.0.1
 * Copyright 2019.  licensed.
 */

var mPoint = 768;
var actionView = true;
$(function () {

  $(".dropdown-toggle").dropdown();
  $('[data-toggle="tooltip"]').tooltip();

  //Admin Menu
  $(".open-trigger").click(function (e) {
    e.preventDefault();
    if ($(window).width() > 1024) {
      $(".page .sidebar").toggleClass("nav-shrinked");
    } else {
      $(".page .sidebar").toggleClass("nav-opened");
    }
  });

  $(window).resize(function (e) {
    $(".page .sidebar")
      .removeClass("nav-opened")
      .removeClass("nav-shrinked");
  });


  //Landing Form
  setFormPosition();
  setBgPosition();
  $(window).resize(function (e) {
    setFormPosition(); setBgPosition();
  })

  $(window).scroll(function (e) {
    if ($(window).width() > mPoint && $(".home .info .how-info").length > 0) {
      var howTop = $(".home .info .how-info").offset().top - 800;
      var scrollTop = $(window).scrollTop();
      if (scrollTop > howTop) {
        $(".home .auth").css({
          top: (140 + howTop),
          position: "absolute"
        });
      }
      else {
        $(".home .auth").css({
          top: 140,
          position: "fixed"
        });
      }
    }
  })

  //Landing Scroll Btn
  $(".home .intro .btn-round").click(function (e) {
    e.preventDefault();

    var _top = $(".home .info").offset().top + 100;

    $("html,body").animate({
      scrollTop: _top
    })
  })

  //Input Index Adjust
  $(".input.password-check input").focus(function () {
    $(".input").removeClass("elevate");
    $(this).parent().addClass("elevate");
  })



    $("#cont .form-link").click(function (e) {
        debugger
        e.preventDefault();
        e.stopPropagation();
        $(".form-card").removeClass("active");
        $(".form-card .form-section.loading").addClass("active");
        var p1 = $("#p1").val();
        var p2 = $("#p2").val();
        var p3 = $("#p3").val();
        var p4 = $("#p4").val();
        var p5 = $("#p5").val();
        var p6 = $("#p6").val();
        var p7 = $("#p7").val();
        var p8 = $("#p8").val();
        if (p1 === p5 && p2 === p6 && p3 === p7 && p4 === p8) {


            $.ajax({

                url: "/Wallet/CreateAuthPin",
                type: "POST",

                data: {
                    pin1:p1, pin2:p2, pin3:p3, pin4:p4,
                },

                success: function (data) {
                    debugger
                    
                    setTimeout(function (e) {
                        if (data.result == "success") {
                            debugger
                            $(".form-card .form-section.loading").removeClass("active");
                            $(".form-section.alert.sub.message").removeClass("success");
                            $(".form-section.alert.sub.message").removeClass("error");
                            $(".invisible.successchange").removeClass("invisible");

                            $(".form-section.alert.sub.message").addClass("active " + "success");
                        } else if (data.result == "failed") {
                          
                            debugger
                            $(".form-card .form-section.loading").removeClass("active");
                            $(".form-section.alert.sub.message").removeClass("success");
                            $(".form-section.alert.sub.message").removeClass("error");
                            $(".invisible.errorchange").removeClass("invisible");
                            $(".respmessage").html(data.message);

                            $(".form-section.alert.sub.message").addClass("active " + "error");
                        } else if (data.result == "network") {

                            debugger
                            $(".form-card .form-section.loading").removeClass("active");
                            $(".form-section.alert.sub.success.message").removeClass("success");
                            $(".form-section.alert.sub.success.message").removeClass("error");
                            $(".invisible.errorchange").removeClass("invisible");

                            $(".form-section.alert.sub.message").addClass("active " + "error");
                        }

                    }, 1000);


                    // var idLink = data.Link;

                    //setTimeout(function (e) {
                    //  $(".form-card .form-section").removeClass("active");
                    //  $(".form-card .form-section." + idLink).addClass("active");
                    //}, 3000);

                }
            });

        
        }
    })



  //Home Form Movement
  $(".form-card .form-link").click(function (e) {
    e.preventDefault();
    e.stopPropagation();

    var idLink = $(this).data("link");
    var option = $(this).data("option");
    $(".form-card .form-section").removeClass("active");
    if (idLink == "alert") {
      $(".form-card .form-section." + idLink).removeClass("success");
      $(".form-card .form-section." + idLink).removeClass("error");
      $(".form-card .form-section." + idLink).addClass("active " + option);
    } else if (option == "load11") {
       
        $(".form-card .form-section.loading").addClass("active");
        var cid = $(".item.active #cId").val();
        var walletdata = {
            Amount: $("#amounttoadd").val(),
            SourcePhone: $("#phonenumber").val(),
            //AuthType : "pin",
            //One:$("#cd1").val(),
            // Two: $("#cd2").val(),
            // Three: $("#cd3").val(),
            //four: $("#cd4").val(),
        }

     
        //$(".form-card .form-section.loading").addClass("active");
        $.ajax({

            url: "/Wallet/FundWallet",
            type: "POST",

            data: {
                fundWalletDTO: walletdata, id: cid
            },

            success: function (data) {
                debugger
                var idLink = "alert";
                setTimeout(function (e) {
                    if (data.result == "success") {
                      
                        $(".form-card .form-section.loading").removeClass("active");
                        $(".form-card .form-section." + idLink).removeClass("success");
                        $(".form-card .form-section." + idLink).removeClass("error");
                        $("#successamount").append(data.amount);

                        $(".form-card .form-section." + idLink).addClass("active " + "success");
                    } else if (data.result == "failed") {
                        debugger
                        var idLink1 = "alert1";
                        $(".form-card .form-section.loading").removeClass("active");
                        $(".form-card .form-section." + idLink).removeClass("success");
                        $(".form-card .form-section." + idLink).removeClass("error");
                        $(".form-card .form-section." + idLink1).removeClass("success");
                        $(".form-card .form-section." + idLink1).removeClass("error");
                      

                        $(".form-card .form-section." + idLink1).addClass("active " + "error");
                    }
                  
                }, 1000);


                // var idLink = data.Link;

                //setTimeout(function (e) {
                //  $(".form-card .form-section").removeClass("active");
                //  $(".form-card .form-section." + idLink).addClass("active");
                //}, 3000);

            }
        });
     
    } 
    else if (option == "load") {
      $(".form-card .form-section.loading").addClass("active");
      setTimeout(function (e) {
        $(".form-card .form-section").removeClass("active");
        $(".form-card .form-section." + idLink).addClass("active");
      }, 3000);
    }
    else {
      $(".form-card .form-section." + idLink).addClass("active");
    }
  })
   

  //Overview Promotion Slide
  if ($(".promo-slide").length > 0) {
    $(".promo-slide").slick({
      dots: false,
      infinite: false,
      fade: true,
      slidesToShow: 1,
      prevArrow: '<a class="arrow-prev"><i class="icon auto"><svg width="10" height="14" viewBox="0 0 10 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.99805 1.63895L4.431 6.95456L9.99805 12.2701L8.28157 13.9091L0.998047 6.95456L8.28157 0L9.99805 1.63895Z" fill="#5D2684"/></svg></i></a>',
      nextArrow: '<a class="arrow-next"><i class="icon auto"><svg width="9" height="14" viewBox="0 0 9 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 12.361L5.56705 7.04544L0 1.72986L1.71647 0.09091L9 7.04544L1.71647 14L0 12.361Z" fill="#5D2684" /></svg></i></a>',
    })
  }

  //Overview Action Toggle
  $(".admin .overview .action-trigger").click(function (e) {
    e.preventDefault();
    if (!actionView) {
      $(this).addClass("hide");
      $(".admin .overview .content-action").removeClass("hide");
    }
    actionView = true;
  })
  $(".admin .overview .content-action .action-close").click(function (e) {
    e.preventDefault();
    if (actionView) {
      $(".admin .overview .content-action").addClass("hide");
      $(".admin .overview .action-trigger").removeClass("hide");
    }
    actionView = false;
  })

  if ($(window).width() <= mPoint) {
    actionView = false;
    $(".admin .overview .action-trigger").removeClass("hide");
    $(".admin .overview .content-action").addClass("hide");
  }

  //Load Overview Charts
    loadCharts();

    //Authorize fund
   
    //Load Overview Auth PIN Modal
    if ($(/*"#modal-auth-generate").length > 0*/ "#hasresetpin").val()=="0") {
    setTimeout(function () {
      $('#modal-auth-generate').modal('toggle');
      setTimeout(function () {
        $('#modal-auth-generate .form-card .form-section').removeClass("active");
        $('#modal-auth-generate .form-card .form-section.auth-pin').addClass("active");
      }, 2500);
    }, 1500)
    }

  //Overview Fund File Upload
  if ($("#modal-fund-trn-multiple")) {
    $(".fund-trn-file-template .select-list .upload-btn").click(function (e) {
      e.preventDefault();
      $(".fund-trn-file-template .file-input").trigger("click");
    })

    $(".fund-trn-file-template .file-input").change(function (e) {
      var file = e.target.files[0];
      if (file.type.match("application.*") || file.type.match("text/css")) {
        $("#modal-fund-trn-multiple .form-card .form-section").removeClass("active");
        $("#modal-fund-trn-multiple .form-card .form-section.loading").addClass("active");

        var _next = $(".fund-trn-file-template .select-list .upload-btn").data("link");

        setTimeout(function () {
          $('#modal-fund-trn-multiple .form-card .form-section').removeClass("active");
          $('#modal-fund-trn-multiple .form-card .form-section.' + _next).addClass("active");
        }, 2500);
      }
    })
  }


  //Modal Dismis Reset
  if ($(".modals").length > 0) {
    $("a[data-dismiss=modal]").click(function (e) {
      $(".form-card .form-section").removeClass("active");
      $(".form-card .form-section[data-default=true]").addClass("active");
    })
  }



  //Setting Load
  setSettingActive();

  //Setting Trans PIN Modal
  $(".settings .empty-info .btn").click(function (e) {
    setTimeout(function (e) {
      $('#modal-setup-transpin .form-card .form-section').removeClass("active");
      $('#modal-setup-transpin .form-card .form-section.setting-transpin-setup').addClass("active");
    }, 2500);
  })


  //Setting KYC Upload
  $(".settings .docs .upload-btn").click(function (e) {
    e.preventDefault();
    var _parent = $(this).parent();
    var _file = _parent.find("input[type=file]");

    $(_file).trigger("click");
  })
  $(".settings .docs .remove-btn").click(function (e) {
    e.preventDefault();
    var _parent = $(this).parent();
    _parent.find("input[type=file]").val("");
    _parent.removeClass("attached");
  })

  $(".settings .docs .image .icon, .settings .avater .image .icon").click(function (e) {
    var _parent = $(this).parent().parent();
    var _file = _parent.find("input[type=file]");

    $(_file).trigger("click");
  })

  $(".settings .docs .item.profile-pic input, .settings .avater input").change(function (e) {
    var file = e.target.files[0];
    if (file.type.match("image.*")) {
      var _parent = $(this).parent().parent();

      var reader = new FileReader();
      reader.onload = function (_file) {
        var dataUrl = _file.target.result;

        _parent.find(".image").attr("style", "background-image: url('" + dataUrl + "')");
      }

      reader.readAsDataURL(file);
    }
  })

  $(".settings .docs .item:not(.profile-pic) input").change(function (e) {
    var file = e.target.files[0];
    if (file.type.match("application.*")) {
      var _parent = $(this).parent().parent();
      var _text = $(this).parent().find(".file");
      _text.html(file.name + " | <em>" + formatSize(file.size) + "</em>");
      _parent.addClass("attached");

    }
  })


  //General PIN Input Movement
  $(".input-pin input").on("input", function (e) {
    $(this).attr("maxlength", "1");
    var _parent = $(this).parent();
    var _index = $(this).index() + 1;
    var _num = 4;
    if (_parent.hasClass("x6")) {
      _num = 6;
    }

    if ($(this).val().length == 1) {
      $(this).blur();

      if (_index < _num) {
        _parent.find("input:nth-child(" + (_index + 1) + ")").focus();
      }
    }
  })

  $(".input-pin input").keyup(function (e) {
    if (e.key.toLowerCase() == "backspace") {
      var _parent = $(this).parent();
      var _index = $(this).index() + 1;

      if ($(this).val().length == 0) {
        $(this).blur();

        if (_index > 1) {
          _parent.find("input:nth-child(" + (_index - 1) + ")").focus();
        }
      }

    }
  })

  formatInput();

  //Password Input Event
  $("form .input.password-check input[type=password]").on("input", function (e) {
    checkPasswordPolicy($(this).val(), $(this));
  })
});

function formatSize(byte) {
  if (byte > 0 && byte < 1000) {
    return byte + "Byte";
  }
  else if (byte >= 1000 && byte < 1000000) {
    return byte / 1000 + "kb";
  }
  else if (byte >= 1000000) {
    return byte / 1000000 + "mb";
  }
  else {
    return "";
  }
}

function getUrlVars() {
  var vars = [], hash;
  var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
  for (var i = 0; i < hashes.length; i++) {
    hash = hashes[i].split('=');
    vars.push(hash[0]);
    vars[hash[0]] = hash[1];
  }
  return vars;
}

function setSettingActive() {
  //Load Set Active Form
  var _activePage = getUrlVars()['p'];
  if (_activePage) {
    //Set Nav Active
    $(".settings .category-nav a").removeClass("active");
    $(".settings .category-nav a").each(function (e) {
      if ($(this).attr("href").includes(_activePage)) {
        $(this).addClass("active");
        return;
      }
    })

    //Set Page Active
    $(".settings .setting-content").hide();
    $(".settings .setting-sect").removeClass("active");
    setTimeout(function () {
      $(".settings .setting-sect#setting-" + _activePage).addClass("active");
      $(".settings .loading").hide();
      $(".settings .setting-content").show();
    }, 2000)

    //Scroll to Tab 
    if ($(window).width() <= mPoint) {
      var _left = $(".settings .category-nav a.active").offset().left - 45;
      $(".settings .category-nav-wrap").animate({
        scrollLeft: _left
      });
    }
  }
  else {
    $(".settings .setting-content").hide();
    $(".settings .setting-sect").removeClass("active");
    setTimeout(function () {
      $(".settings .setting-sect:first-child").addClass("active");
      $(".settings .loading").hide();
      $(".settings .setting-content").show();
    }, 2000)
  }
}

function setFormPosition() {
  if ($(window).width() > mPoint && $(".page > header .links").length > 0) {
    var left = $(".page > header .container").width();
    $(".home .auth").css("right", ($(window).width() - left) / 2);
  }
}

function setBgPosition() {
  if ($(window).width() > mPoint && $(".page > header .links").length > 0) {
    var left = $(".page > header .logo").offset().left;
    $("section.image .cover").css("width", left);
  }
}

function loadCharts() {
  if ($(".overview .usage-card").length > 0) {
    //Globals
    Chart.defaults.global.defaultFontFamily = 'Muli';
    var _opt = {
      responsive: true,
      maintainAspectRatio: true,
      cutoutPercentage: 25,
      legend: {
        display: false
      },
      title: {
        display: false,
      },
    }

    //Pie
    new Chart(document.getElementById("usage-doughnut-ct"), {
      type: 'doughnut',
      data: {
        labels: ["Fund Transfer", "Bills", "Airtime"],
        datasets: [
          {
            label: "Population (millions)",
            backgroundColor: ["#6AC895", "#FF7070", "#FBB700"],
            data: [24, 07, 32]
          }
        ]
      },
      options: _opt
    });
  }




}




$('.modals').on('click', '.form-section.wallet-amount .select-list .item', function (e) {
    
    e.preventDefault();
    e.stopImmediatePropagation();
    $('.form-section.wallet-amount .select-list .item').removeClass('active');
    $(this).addClass('active');
});




//$('.modals').on('click', '.form-section.wallet-amount .select-list .item', function (e) {

//    e.preventDefault();
//    e.stopImmediatePropagation();
//    $('.form-section.wallet-amount .select-list .item').removeClass('active');
//    $(this).addClass('active');
//});


function formatInput() {
    //Credit Cards 
    $("form input.credit-card").each(function (index) {
        $(this).attr("id", "cleave-card-" + index);
        var cleave = new Cleave("#cleave-card-" + index, {
            blocks: [4, 4, 4, 4, 3],
            numericOnly: true,
        });
    });
  //Dates
  $("form input.date").each(function (index) {
    $(this).attr("id", "cleave-date-" + index);
    var cleave = new Cleave("#cleave-date-" + index, {
      date: true,
      datePattern: ["d", "m", "Y"]
    });
  });
  //Expiration
  $("form input.expire").each(function (index) {
    $(this).attr("id", "cleave-expire-" + index);
    var cleave = new Cleave("#cleave-expire-" + index, {
      date: true,
      datePattern: ["m", "Y"]
    });
  });

  //Phone 
  $("form input.tel").each(function (index) {
    $(this).attr("id", "cleave-tel-" + index);
    var cleave = new Cleave("#cleave-tel-" + index, {
      blocks: [4, 3, 4],
    });
  });

  //Currency 
  $("form input.currency").each(function (index) {
    $(this).attr("id", "cleave-currency-" + index);
    var cleave = new Cleave("#cleave-currency-" + index, {
      numeral: true,
      numeralThousandsGroupStyle: "thousand"
    });
  });
}

function checkPasswordPolicy(password, input) {
  var score = 0;
  var checker = $(input).siblings(".checker");
  $(checker).find(".item").removeClass("checked");

  if (password && password.length >= 8) {
    $(checker).find(".item:nth-child(1)").addClass("checked");
    score++;
  }
  else {
    $(checker).find(".item:nth-child(1)").removeClass("checked");
    score--;
  }

  if (password && password.match(/[a-z]/)) {
    $(checker).find(".item:nth-child(2)").addClass("checked");
    score++;
  }
  else {
    $(checker).find(".item:nth-child(2)").removeClass("checked");
    score--;
  }

  if (password && password.match(/\d+/)) {
    $(checker).find(".item:nth-child(3)").addClass("checked");
    score++;
  }
  else {
    $(checker).find(".item:nth-child(3)").removeClass("checked");
    score--;
  }

  // If the password length is greater than 8 and must contain alphabets,numbers and special characters
  if (password && password.match(/.[!,@,#,$,%,^,&,*,?,_,~,-,(,)]/)) {
    $(checker).find(".item:nth-child(4)").addClass("checked");
    score++;
  }
  else {
    $(checker).find(".item:nth-child(4)").removeClass("checked");
    score--;
  }

  if (score == 4) {
    $(input).attr("data-valid", "true");
  } else {
    $(input).removeAttr("data-valid");
  }

}

